---
/**
 * Blog Article page - Individual story pages
 * Loads content from cinqueterre.travel/content/blog/[slug].json
 */
import Layout from '../../../layouts/Layout.astro';
import ContentRenderer from '../../../ContentRenderer.astro';
import Footer from '../../../components/Footer';
import { BLOG_DIR } from '../../../config/content-paths';
import fs from 'fs';
import path from 'path';

export async function getStaticPaths() {
  // Blog directory resolved from environment or relative paths
  const SUPPORTED_LANGS = ['en', 'de', 'fr', 'it'];

  if (!fs.existsSync(BLOG_DIR)) {
    return [];
  }

  const files = fs.readdirSync(BLOG_DIR).filter(f => f.endsWith('.json'));
  const paths: any[] = [];

  for (const file of files) {
    const slug = file.replace('.json', '');
    const content = JSON.parse(fs.readFileSync(path.join(BLOG_DIR, file), 'utf-8'));

    for (const lang of SUPPORTED_LANGS) {
      paths.push({
        params: { lang, slug },
        props: {
          pageData: {
            ...content,
            currentLang: lang,
            title: content.title?.[lang] || content.title?.en || content.title,
            seo: {
              title: content.seo?.title?.[lang] || content.seo?.title?.en,
              description: content.seo?.description?.[lang] || content.seo?.description?.en,
            }
          }
        }
      });
    }
  }

  return paths;
}

const { lang, slug } = Astro.params;
const { pageData } = Astro.props;

if (!pageData) {
  return Astro.redirect('/blog');
}

const title = pageData.seo?.title || pageData.title || 'The Dispatch';
const description = pageData.seo?.description || '';
const body = pageData.body || [];
const locale = lang || 'en';
---

<Layout title={title} description={description} locale={locale}>
  <ContentRenderer blocks={body} locale={locale} />
  <Footer />
</Layout>
