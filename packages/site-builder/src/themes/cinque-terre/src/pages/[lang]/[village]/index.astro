---
/**
 * Village Page
 *
 * Route: /{lang}/{village}
 * Examples: /en/riomaggiore, /de/manarola
 *
 * Uses the village.json template structure for all villages,
 * with components loading village-specific content based on the URL parameter.
 * This ensures all village pages have the same beautiful editorial design
 * as the /en/village hub page.
 */
import Layout from '../../../layouts/Layout.astro';
import ContentRenderer from '../../../ContentRenderer.astro';
import Footer from '../../../components/Footer';
import fs from 'fs';
import path from 'path';
import { VILLAGES } from '../../../config/navigation.config';
import { getVillageContent } from '../../../config/village-content.config';
import type { SupportedLanguage } from '../../../types/navigation.types';

export async function getStaticPaths() {
  const CONTENT_DIR = process.env.CONTENT_DIR || '/Users/drietsch/agentpress/cinqueterre.travel/content/pages';
  const SUPPORTED_LANGS: SupportedLanguage[] = ['en', 'de', 'fr', 'it'];
  const paths = [];

  for (const lang of SUPPORTED_LANGS) {
    for (const village of VILLAGES) {
      // Try to load village-specific overview content first
      // e.g., /riomaggiore/overview.json
      const villageOverviewPath = path.join(CONTENT_DIR, village.slug, 'overview.json');
      let pageData = null;

      if (fs.existsSync(villageOverviewPath)) {
        const content = JSON.parse(fs.readFileSync(villageOverviewPath, 'utf-8'));
        pageData = {
          ...content,
          currentLang: lang,
          title: content.title?.[lang] || content.title?.en || content.title,
          seo: {
            title: content.seo?.title?.[lang] || content.seo?.title?.en,
            description: content.seo?.description?.[lang] || content.seo?.description?.en,
          }
        };
      } else {
        // Fall back to village.json template if no village-specific content
        const templatePath = path.join(CONTENT_DIR, 'village.json');
        if (fs.existsSync(templatePath)) {
          const content = JSON.parse(fs.readFileSync(templatePath, 'utf-8'));
          pageData = {
            ...content,
            currentLang: lang,
          };
        }
      }

      // Get village-specific content for SEO fallback
      const villageContent = getVillageContent(village.slug);

      paths.push({
        params: {
          lang,
          village: village.slug,
        },
        props: {
          pageData,
          villageData: village,
          villageContent,
          locale: lang,
        },
      });
    }
  }

  return paths;
}

const { lang, village } = Astro.params;
const { pageData, villageData, villageContent, locale } = Astro.props;

// If no page data, redirect to homepage
if (!pageData) {
  return Astro.redirect(`/${lang}`);
}

// Use page-specific SEO content, or fall back to village content
const title = pageData.seo?.title || villageContent?.seo?.title?.[locale] || `${villageData.name[locale]} | Cinque Terre Dispatch`;
const description = pageData.seo?.description || villageContent?.seo?.description?.[locale] || '';

// Use the page body
const body = pageData.body || [];
---

<Layout title={title} description={description} locale={locale}>
  <ContentRenderer blocks={body} locale={locale} village={village} />
  <Footer client:visible />
</Layout>
