---
/**
 * Village Page
 *
 * Route: /{lang}/{village}
 * Examples: /en/riomaggiore, /de/manarola
 *
 * Uses the village.json template structure for all villages,
 * with components loading village-specific content based on the URL parameter.
 * This ensures all village pages have the same beautiful editorial design
 * as the /en/village hub page.
 */
import Layout from '../../../layouts/Layout.astro';
import ContentRenderer from '../../../ContentRenderer.astro';
import Footer from '../../../components/Footer';
import fs from 'fs';
import path from 'path';
import { VILLAGES } from '../../../config/navigation.config';
import { getVillageContent } from '../../../config/village-content.config';
import type { SupportedLanguage } from '../../../types/navigation.types';

export async function getStaticPaths() {
  const CONTENT_DIR = process.env.CONTENT_DIR || '/Users/drietsch/agentpress/cinqueterre.travel/content/pages';
  const SUPPORTED_LANGS: SupportedLanguage[] = ['en', 'de', 'fr', 'it'];
  const paths = [];

  // Load the village.json template (used for all village pages)
  const templatePath = path.join(CONTENT_DIR, 'village.json');
  let templateData = null;

  if (fs.existsSync(templatePath)) {
    templateData = JSON.parse(fs.readFileSync(templatePath, 'utf-8'));
  }

  for (const lang of SUPPORTED_LANGS) {
    for (const village of VILLAGES) {
      // Get village-specific content for SEO
      const villageContent = getVillageContent(village.slug);

      paths.push({
        params: {
          lang,
          village: village.slug,
        },
        props: {
          templateData,
          villageData: village,
          villageContent,
          locale: lang,
        },
      });
    }
  }

  return paths;
}

const { lang, village } = Astro.params;
const { templateData, villageData, villageContent, locale } = Astro.props;

// If no template, redirect to homepage
if (!templateData) {
  return Astro.redirect(`/${lang}`);
}

// Use village-specific SEO content
const title = villageContent?.seo?.title?.[locale] || `${villageData.name[locale]} | Cinque Terre Dispatch`;
const description = villageContent?.seo?.description?.[locale] || '';

// Use the template body (same blocks for all villages)
const body = templateData.body || [];
---

<Layout title={title} description={description} locale={locale}>
  <ContentRenderer blocks={body} locale={locale} village={village} />
  <Footer client:visible />
</Layout>
