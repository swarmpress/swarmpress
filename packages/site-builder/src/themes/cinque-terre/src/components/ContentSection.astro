---
/**
 * Content Section Component
 * Renders markdown-style content blocks with rich text
 * Handles both array of strings and single string with newline separators
 * Supports LocalizedText/LocalizedArray for multi-language content
 */
import { getText, getArray, resolveItem, type LocalizedText, type LocalizedArray } from '../config/localization';

interface Props {
    content?: string[] | string | LocalizedText | LocalizedArray;
    title?: string | LocalizedText;
    subtitle?: string | LocalizedText;
    image?: string;
    id?: string;
    locale?: string;
}

const { content: contentProp = [], title: titleProp, subtitle: subtitleProp, image, id, locale = 'en' } = Astro.props;

// Resolve localized strings
const title = getText(titleProp as LocalizedText, locale);
const subtitle = getText(subtitleProp as LocalizedText, locale);

// Normalize content to array of paragraphs (with LocalizedText support)
function normalizeContent(c: string[] | string | LocalizedText | LocalizedArray | Array<{type?: string; text?: string | LocalizedText}>): string[] {
    // Handle LocalizedArray (object with locale keys pointing to arrays)
    if (c && typeof c === 'object' && !Array.isArray(c)) {
        // Check if it's a LocalizedArray (has locale keys with array values)
        if ('en' in c || 'de' in c || 'fr' in c || 'it' in c) {
            const localizedValue = (c as Record<string, unknown>)[locale] || (c as Record<string, unknown>).en;
            if (Array.isArray(localizedValue)) {
                return localizedValue.map(item => resolveItem(item, locale)).filter(p => p.trim());
            }
            // It's a LocalizedText (single string value)
            const stringValue = getText(c as LocalizedText, locale);
            return stringValue ? stringValue.split('\n\n').filter(p => p.trim()) : [];
        }
    }

    if (Array.isArray(c)) {
        // Handle array of objects with text property (e.g., {type: "paragraph", text: "..."})
        if (c.length > 0 && typeof c[0] === 'object' && c[0] !== null && 'text' in c[0]) {
            return c.map(item => {
                if (typeof item === 'object' && item !== null && 'text' in item) {
                    return getText(item.text as LocalizedText, locale);
                }
                return resolveItem(item as string | LocalizedText, locale);
            }).filter(p => p.trim());
        }
        // Handle array of strings or LocalizedText
        return c.map(item => resolveItem(item as string | LocalizedText, locale)).filter(p => p.trim());
    }
    if (typeof c === 'string') {
        return c.split('\n\n').filter(p => p.trim());
    }
    return [];
}

const paragraphs = normalizeContent(contentProp);

// Simple markdown-like processing for bold text
function processText(text: string): string {
    return text
        .replace(/\*\*(.+?)\*\*/g, '<strong class="font-semibold text-gray-900">$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>');
}
---

<section class="py-16 md:py-24 bg-white" id={id}>
    <div class="container mx-auto px-4">
        <div class={`${image ? 'grid md:grid-cols-2 gap-12 items-center max-w-6xl' : 'max-w-4xl'} mx-auto`}>
            {image && (
                <div class="order-2 md:order-1">
                    <img
                        src={image}
                        alt={title || 'Content image'}
                        class="rounded-lg shadow-lg w-full h-auto object-cover"
                    />
                </div>
            )}
            <div class={image ? 'order-1 md:order-2' : ''}>
                {title && (
                    <h2 class={`text-3xl md:text-4xl font-serif text-gray-900 mb-4 ${!image ? 'text-center' : ''}`}>
                        {title}
                    </h2>
                )}
                {subtitle && (
                    <p class={`text-lg text-gray-600 mb-8 ${!image ? 'text-center max-w-2xl mx-auto' : ''}`}>
                        {subtitle}
                    </p>
                )}
                <div class="prose prose-lg prose-gray max-w-none">
                    {paragraphs.map((paragraph) => (
                        <p
                            class="text-gray-700 leading-relaxed mb-6"
                            set:html={processText(paragraph)}
                        />
                    ))}
                </div>
            </div>
        </div>
    </div>
</section>
