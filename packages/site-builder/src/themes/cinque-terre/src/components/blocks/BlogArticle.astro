---
/**
 * BlogArticle Block
 *
 * Full blog article renderer with prose content
 */
interface ContentBlock {
  type: 'paragraph' | 'heading' | 'image' | 'quote' | 'list';
  text?: string;
  level?: number;
  src?: string;
  alt?: string;
  caption?: string;
  items?: string[];
  ordered?: boolean;
}

interface SidebarContent {
  keyTakeaways?: string[];
  relatedPosts?: Array<{
    title: string;
    url: string;
    image?: string;
  }>;
}

interface Author {
  name: string;
  bio?: string;
  image?: string;
}

// Alternative content format (editorial style)
interface EditorialContent {
  intro?: string;
  sections?: Array<{
    title: string;
    text: string;
  }>;
  quote?: {
    text: string;
    author?: string;
  };
}

// Blog post metadata
interface PostMeta {
  title?: string;
  subtitle?: string;
  author?: string;
  authorBio?: string;
  date?: string;
  readTime?: string;
  category?: string;
  image?: string;
  tags?: string[];
}

interface Props {
  title?: string;
  subtitle?: string;
  author?: string | Author;
  authorImage?: string;
  date?: string;
  readTime?: string;
  category?: string;
  image?: string;
  heroImage?: string;
  content?: ContentBlock[] | EditorialContent;
  sidebar?: SidebarContent;
  // Alternative structure from JSON
  post?: PostMeta;
}

const {
  title: titleProp,
  subtitle: subtitleProp,
  author: authorProp,
  authorImage: authorImageProp,
  date: dateProp,
  readTime: readTimeProp,
  category: categoryProp,
  image: imageProp,
  heroImage,
  content,
  sidebar,
  post
} = Astro.props;

// Use post metadata if available, otherwise fall back to direct props
const title = post?.title || titleProp;
const subtitle = post?.subtitle || subtitleProp;
const date = post?.date || dateProp;
const readTime = post?.readTime || readTimeProp;
const category = post?.category || categoryProp;
const image = post?.image || imageProp;

// Normalize author - can be string or object
const authorSource = post?.author || authorProp;
const author = typeof authorSource === 'object' && authorSource !== null ? (authorSource as Author).name : (authorSource || 'Giulia Rossi');
const authorImage = typeof authorSource === 'object' && authorSource !== null ? (authorSource as Author).image : authorImageProp;
const authorBio = post?.authorBio || (typeof authorSource === 'object' && authorSource !== null ? (authorSource as Author).bio : undefined);

// Check if content is editorial format (object with intro/sections) or ContentBlock array
const isEditorialContent = content && !Array.isArray(content);
const editorialContent = isEditorialContent ? content as EditorialContent : null;
const blockContent = !isEditorialContent && Array.isArray(content) ? content as ContentBlock[] : null;
---

<article class="py-16">
  <div class="container mx-auto px-4">
    <!-- Header -->
    <header class="max-w-4xl mx-auto mb-16 text-center">
      {category && (
        <div class="inline-block px-3 py-1 rounded-full bg-primary/10 text-primary text-xs font-bold uppercase tracking-widest mb-6">
          {category}
        </div>
      )}
      <h1 class="font-serif text-4xl md:text-6xl font-bold text-foreground mb-8 leading-tight">
        {title}
      </h1>

      <div class="flex items-center justify-center gap-6 text-sm text-muted-foreground">
        {author && (
          <div class="flex items-center gap-3">
            {authorImage && (
              <img
                src={authorImage}
                alt={author}
                class="w-10 h-10 rounded-full object-cover"
              />
            )}
            <span class="font-medium text-foreground">{author}</span>
          </div>
        )}
        {date && <span>{date}</span>}
        {readTime && <span>{readTime}</span>}
      </div>
    </header>

    <!-- Hero Image -->
    {heroImage && (
      <div class="max-w-5xl mx-auto mb-16">
        <div class="aspect-[21/9] rounded-2xl overflow-hidden">
          <img
            src={heroImage}
            alt={title}
            class="w-full h-full object-cover"
          />
        </div>
      </div>
    )}

    <!-- Content Grid -->
    <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-4 gap-16">
      <!-- Main Content -->
      <div class="lg:col-span-3">
        <div class="prose prose-lg prose-slate max-w-none">
          {/* Editorial format with intro/sections/quote */}
          {editorialContent && (
            <>
              {editorialContent.intro && (
                <p class="text-foreground/80 leading-relaxed mb-6 text-lg font-serif italic">
                  {editorialContent.intro}
                </p>
              )}
              {editorialContent.sections?.map((section) => (
                <>
                  <h2 class="font-serif text-3xl font-bold text-foreground mt-12 mb-6">{section.title}</h2>
                  <p class="text-foreground/80 leading-relaxed mb-6">{section.text}</p>
                </>
              ))}
              {editorialContent.quote && (
                <blockquote class="border-l-4 border-primary pl-6 my-12 italic">
                  <p class="font-serif text-xl text-foreground/80 mb-4">"{editorialContent.quote.text}"</p>
                  {editorialContent.quote.author && (
                    <cite class="text-sm text-muted-foreground not-italic">— {editorialContent.quote.author}</cite>
                  )}
                </blockquote>
              )}
            </>
          )}

          {/* ContentBlock array format */}
          {blockContent && blockContent.map((block) => {
            switch (block.type) {
              case 'paragraph':
                return <p class="text-foreground/80 leading-relaxed mb-6">{block.text}</p>;

              case 'heading':
                if (block.level === 2) {
                  return <h2 class="font-serif text-3xl font-bold text-foreground mt-12 mb-6">{block.text}</h2>;
                } else if (block.level === 3) {
                  return <h3 class="font-serif text-2xl font-bold text-foreground mt-10 mb-4">{block.text}</h3>;
                }
                return <h4 class="font-serif text-xl font-bold text-foreground mt-8 mb-4">{block.text}</h4>;

              case 'image':
                return (
                  <figure class="my-12">
                    <div class="rounded-xl overflow-hidden">
                      <img
                        src={block.src}
                        alt={block.alt || ''}
                        class="w-full h-auto"
                      />
                    </div>
                    {block.caption && (
                      <figcaption class="text-center text-sm text-muted-foreground mt-4 italic">
                        {block.caption}
                      </figcaption>
                    )}
                  </figure>
                );

              case 'quote':
                return (
                  <blockquote class="border-l-4 border-primary pl-6 my-8 italic">
                    <p class="font-serif text-xl text-foreground/80">{block.text}</p>
                  </blockquote>
                );

              case 'list':
                if (block.ordered) {
                  return (
                    <ol class="list-decimal list-inside space-y-2 my-6">
                      {block.items?.map(item => (
                        <li class="text-foreground/80">{item}</li>
                      ))}
                    </ol>
                  );
                }
                return (
                  <ul class="list-disc list-inside space-y-2 my-6">
                    {block.items?.map(item => (
                      <li class="text-foreground/80">{item}</li>
                    ))}
                  </ul>
                );

              default:
                return null;
            }
          })}
        </div>
      </div>

      <!-- Sidebar -->
      {sidebar && (
        <aside class="lg:col-span-1">
          <div class="sticky top-24 space-y-10">
            {sidebar.keyTakeaways && sidebar.keyTakeaways.length > 0 && (
              <div class="bg-secondary/50 rounded-2xl p-6 border border-border/40">
                <h3 class="text-[10px] font-bold uppercase tracking-[0.2em] text-primary mb-4">
                  Key Takeaways
                </h3>
                <ul class="space-y-3">
                  {sidebar.keyTakeaways.map(takeaway => (
                    <li class="flex items-start gap-3 text-sm text-foreground/80">
                      <span class="text-primary mt-1">•</span>
                      {takeaway}
                    </li>
                  ))}
                </ul>
              </div>
            )}

            {sidebar.relatedPosts && sidebar.relatedPosts.length > 0 && (
              <div>
                <h3 class="text-[10px] font-bold uppercase tracking-[0.2em] text-primary mb-4">
                  Related Stories
                </h3>
                <div class="space-y-4">
                  {sidebar.relatedPosts.map(post => (
                    <a
                      href={post.url}
                      class="block group"
                    >
                      {post.image && (
                        <div class="aspect-video rounded-lg overflow-hidden mb-2">
                          <img
                            src={post.image}
                            alt={post.title}
                            class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                          />
                        </div>
                      )}
                      <h4 class="text-sm font-medium text-foreground group-hover:text-primary transition-colors">
                        {post.title}
                      </h4>
                    </a>
                  ))}
                </div>
              </div>
            )}
          </div>
        </aside>
      )}
    </div>
  </div>
</article>

<style>
  .font-serif {
    letter-spacing: -0.02em;
  }
</style>
