---
/**
 * Closing Note Block - JSON-compatible wrapper
 * Renders ClosingNote with content and actions from props instead of slots
 * Supports both string and multi-language object formats
 */
import { marked } from 'marked';

type LocalizedText = string | { en?: string; de?: string; fr?: string; it?: string };
type LocalizedArray = string[] | { en?: string[]; de?: string[]; fr?: string[]; it?: string[] };

interface Action {
  label?: LocalizedText;
  text?: LocalizedText;
  href?: string;
  url?: string;
  variant?: 'primary' | 'secondary';
}

interface Props {
  badge?: LocalizedText;
  title: LocalizedText;
  content: LocalizedText | LocalizedArray;
  actions?: Action[];
  buttons?: Action[];
  backgroundIcon?: string;
  locale?: string;
}

const {
  badge: badgeProp = "A Final Reflection",
  title: titleProp,
  content: contentProp,
  actions: actionsProp = [],
  buttons: buttonsProp = [],
  backgroundIcon,
  locale = 'en'
} = Astro.props;

// Helper to get localized text
function getText(value: LocalizedText | undefined, lang: string): string {
  if (!value) return '';
  if (typeof value === 'string') return value;
  return value[lang as keyof typeof value] || value.en || Object.values(value)[0] || '';
}

// Helper to get localized array
function getArray(value: LocalizedArray | undefined, lang: string): string[] {
  if (!value) return [];
  if (Array.isArray(value)) return value;
  return value[lang as keyof typeof value] || value.en || Object.values(value)[0] || [];
}

const badge = getText(badgeProp, locale);
const title = getText(titleProp, locale);

// Helper to resolve a single item which might be LocalizedText
function resolveItem(item: string | LocalizedText, lang: string): string {
  if (typeof item === 'string') return item;
  if (typeof item === 'object' && item !== null) {
    return (item as Record<string, string>)[lang] || (item as Record<string, string>).en || Object.values(item)[0] || '';
  }
  return '';
}

// Handle content - can be string, array, or localized versions
let content: string;
if (typeof contentProp === 'string') {
  content = contentProp;
} else if (Array.isArray(contentProp)) {
  // Array items might be LocalizedText objects
  content = contentProp.map(p => {
    const resolved = resolveItem(p, locale);
    return `<p>${marked.parseInline(resolved)}</p>`;
  }).join('');
} else if (contentProp && typeof contentProp === 'object') {
  const localized = contentProp[locale as keyof typeof contentProp] || contentProp.en;
  if (Array.isArray(localized)) {
    content = localized.map(p => {
      const resolved = resolveItem(p, locale);
      return `<p>${marked.parseInline(resolved)}</p>`;
    }).join('');
  } else if (typeof localized === 'string') {
    content = localized;
  } else {
    content = '';
  }
} else {
  content = '';
}

// Handle actions/buttons - support both naming conventions
const rawActions = actionsProp.length > 0 ? actionsProp : buttonsProp;
const actions = rawActions.map(action => ({
  label: getText(action.label || action.text, locale),
  href: action.href || action.url || '#',
  variant: action.variant
}));
---

<section class="py-32 bg-foreground text-background overflow-hidden relative">
    {backgroundIcon && (
        <div class="absolute top-0 right-0 w-1/2 h-full opacity-[0.05] pointer-events-none">
            <!-- Background icon would be rendered here if provided -->
        </div>
    )}
    <div class="container mx-auto px-4 relative">
        <div class="max-w-3xl mx-auto text-center space-y-10">
            <div class="inline-flex items-center gap-4">
                <div class="h-px w-8 bg-background/30"></div>
                <span class="text-[10px] font-bold uppercase tracking-[0.4em] text-primary">{badge}</span>
                <div class="h-px w-8 bg-background/30"></div>
            </div>

            <h2 class="font-serif text-4xl md:text-6xl font-bold leading-tight">
                {title}
            </h2>

            <div class="space-y-6 text-xl text-background/70 font-light leading-relaxed" set:html={content} />

            {actions && actions.length > 0 && (
                <div class="pt-12 flex flex-wrap justify-center gap-6">
                    {actions.map((action) => (
                        <a
                            href={action.href}
                            class={`px-8 py-4 rounded-full font-bold text-sm uppercase tracking-widest transition-colors ${
                                action.variant === 'secondary'
                                    ? 'bg-white/10 backdrop-blur-sm text-white hover:bg-white/20'
                                    : 'bg-primary text-white hover:bg-primary/90'
                            }`}
                        >
                            {action.label}
                        </a>
                    ))}
                </div>
            )}
        </div>
    </div>
</section>
