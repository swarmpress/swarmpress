---
/**
 * Collections List Page
 * Manage collection types for the current website
 * Data comes from GitHub (source of truth)
 */
import Layout from '../../layouts/Layout.astro'
import { trpc, handleTRPCError } from '../../lib/trpc'
import { getSessionContext } from '../../lib/session'

const title = 'Collections'

// Get session to check for selected website
const session = getSessionContext(Astro.cookies)
const websiteId = session.productId

// Fetch collections from GitHub (source of truth)
let collections: any[] = []
let error: string | null = null

if (websiteId) {
  try {
    // Fetch all collection schemas from GitHub
    const result = await trpc.github.getAllCollectionSchemas.query({
      websiteId,
    })
    collections = result.collections || []
  } catch (e) {
    error = handleTRPCError(e)
    console.error('Failed to fetch collections from GitHub:', error)
  }
}
---

<Layout title={title}>
  <div class="mb-8">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Collections</h1>
        <p class="text-gray-600 mt-2">
          Content collections from GitHub repository
        </p>
      </div>
      {websiteId && (
        <div class="flex items-center gap-2 text-sm text-gray-500">
          <span class="inline-flex items-center gap-1 px-2 py-1 bg-gray-100 rounded-md">
            <span>üêô</span>
            <span>Source: GitHub</span>
          </span>
        </div>
      )}
    </div>
  </div>

  {!websiteId ? (
    <div class="text-center py-12 bg-amber-50 border border-amber-200 rounded-lg">
      <div class="text-4xl mb-4">üåê</div>
      <h3 class="text-xl font-semibold text-gray-900 mb-2">No Website Selected</h3>
      <p class="text-gray-600 mb-6">
        Please select a website from the sidebar to manage its collections
      </p>
      <a
        href="/websites"
        class="inline-block px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
      >
        View Websites
      </a>
    </div>
  ) : error ? (
    <div class="text-center py-12 text-red-600 bg-red-50 border border-red-200 rounded-lg">
      <p>Failed to load collections: {error}</p>
    </div>
  ) : collections.length === 0 ? (
    <div class="text-center py-12 bg-gray-50 rounded-lg">
      <div class="text-6xl mb-4">üóÇÔ∏è</div>
      <h3 class="text-xl font-semibold text-gray-900 mb-2">No Collections Yet</h3>
      <p class="text-gray-600 mb-6">
        No collections found in the GitHub repository. Add a collection folder with a _schema.json file.
      </p>
    </div>
  ) : (
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {collections.map((collection) => (
        <div class="bg-white rounded-lg border-2 border-gray-200 hover:border-blue-400 transition-colors p-6">
          <div class="flex items-start justify-between mb-4">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-2">
                {collection.icon && (
                  <span class="text-2xl">{collection.icon}</span>
                )}
                {collection.color && (
                  <span
                    class="w-3 h-3 rounded-full"
                    style={`background-color: ${collection.color}`}
                  ></span>
                )}
              </div>
              <h3 class="text-lg font-semibold text-gray-900 mb-1">
                {collection.display_name}
              </h3>
              {collection.description && (
                <p class="text-sm text-gray-600 line-clamp-2">
                  {collection.description}
                </p>
              )}
            </div>
          </div>

          <div class="space-y-2 mb-4 text-sm text-gray-500">
            <div class="flex items-center gap-2">
              <span>üìù</span>
              <span>Title field: <code class="text-xs bg-gray-100 px-1 rounded">{collection.title_field || 'name'}</code></span>
            </div>
            {collection.singular_name && (
              <div class="flex items-center gap-2">
                <span>üìå</span>
                <span>Singular: {collection.singular_name}</span>
              </div>
            )}
          </div>

          <div class="flex flex-col gap-2 pt-4 border-t">
            <a
              href={`/collections/${collection.type}`}
              class="px-3 py-2 text-center text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
            >
              View Items
            </a>
            <a
              href={`/collections/${collection.type}/schema`}
              class="px-3 py-2 text-center text-sm border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors"
            >
              View Schema
            </a>
          </div>
        </div>
      ))}
    </div>
  )}
</Layout>
