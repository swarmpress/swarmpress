---
/**
 * Collections List Page
 * Manage collection types for the current website
 */
import Layout from '../../layouts/Layout.astro'
import { trpc, handleTRPCError } from '../../lib/trpc'
import { getSessionContext } from '../../lib/session'

const title = 'Collections'

// Get session to check for selected website
const session = getSessionContext(Astro.cookies)
const websiteId = session.productId

// Fetch collections and stats server-side
let collections: any[] = []
let stats: any[] = []
let error: string | null = null

if (websiteId) {
  try {
    // Fetch all collections (including disabled)
    const result = await trpc.collection.listTypes.query({
      websiteId,
      enabledOnly: false,
    })
    collections = result || []

    // Fetch stats for all collections
    const statsResult = await trpc.collection.getStats.query({
      websiteId,
    })
    stats = Array.isArray(statsResult) ? statsResult : []
  } catch (e) {
    error = handleTRPCError(e)
    console.error('Failed to fetch collections:', error)
  }
}

// Merge stats with collections
const collectionsWithStats = collections.map((col) => {
  const colStats = stats.find((s) => s.type === col.type) || { total: 0, published: 0, draft: 0 }
  return { ...col, ...colStats }
})
---

<Layout title={title}>
  <div class="mb-8">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Collections</h1>
        <p class="text-gray-600 mt-2">
          Manage structured content collections for your website
        </p>
      </div>
      {websiteId && (
        <a
          href="/collections/new"
          class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
        >
          + New Collection
        </a>
      )}
    </div>
  </div>

  {!websiteId ? (
    <div class="text-center py-12 bg-amber-50 border border-amber-200 rounded-lg">
      <div class="text-4xl mb-4">üåê</div>
      <h3 class="text-xl font-semibold text-gray-900 mb-2">No Website Selected</h3>
      <p class="text-gray-600 mb-6">
        Please select a website from the sidebar to manage its collections
      </p>
      <a
        href="/websites"
        class="inline-block px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
      >
        View Websites
      </a>
    </div>
  ) : error ? (
    <div class="text-center py-12 text-red-600 bg-red-50 border border-red-200 rounded-lg">
      <p>Failed to load collections: {error}</p>
    </div>
  ) : collectionsWithStats.length === 0 ? (
    <div class="text-center py-12 bg-gray-50 rounded-lg">
      <div class="text-6xl mb-4">üóÇÔ∏è</div>
      <h3 class="text-xl font-semibold text-gray-900 mb-2">No Collections Yet</h3>
      <p class="text-gray-600 mb-6">
        Create your first collection to organize structured content like events, POIs, or custom data
      </p>
      <a
        href="/collections/new"
        class="inline-block px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
      >
        Create First Collection
      </a>
    </div>
  ) : (
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {collectionsWithStats.map((collection) => (
        <div class:list={[
          "bg-white rounded-lg border-2 transition-colors p-6",
          collection.enabled ? "border-gray-200 hover:border-blue-400" : "border-gray-100 bg-gray-50 opacity-75"
        ]}>
          <div class="flex items-start justify-between mb-4">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-2">
                {collection.icon && (
                  <span class="text-2xl">{collection.icon}</span>
                )}
                {!collection.enabled && (
                  <span class="text-xs font-medium text-gray-400 uppercase tracking-wide bg-gray-200 px-2 py-0.5 rounded">
                    Disabled
                  </span>
                )}
              </div>
              <h3 class="text-lg font-semibold text-gray-900 mb-1">
                {collection.displayName}
              </h3>
              {collection.description && (
                <p class="text-sm text-gray-600 line-clamp-2">
                  {collection.description}
                </p>
              )}
            </div>
          </div>

          <div class="space-y-2 mb-4">
            <div class="flex items-center justify-between text-sm">
              <span class="text-gray-600">Total Items</span>
              <span class="font-semibold text-gray-900">{collection.total || 0}</span>
            </div>
            <div class="flex items-center justify-between text-sm">
              <span class="text-green-600">Published</span>
              <span class="font-medium text-green-600">{collection.published || 0}</span>
            </div>
            <div class="flex items-center justify-between text-sm">
              <span class="text-amber-600">Drafts</span>
              <span class="font-medium text-amber-600">{collection.draft || 0}</span>
            </div>
          </div>

          <div class="flex flex-col gap-2 pt-4 border-t">
            <a
              href={`/collections/${collection.type}`}
              class="px-3 py-2 text-center text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
            >
              View Items
            </a>
            <div class="flex gap-2">
              <a
                href={`/collections/${collection.type}/settings`}
                class="flex-1 px-3 py-2 text-center text-sm border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors"
              >
                Settings
              </a>
              <a
                href={`/collections/${collection.type}/research`}
                class="flex-1 px-3 py-2 text-center text-sm border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors"
              >
                Research
              </a>
            </div>
          </div>
        </div>
      ))}
    </div>
  )}
</Layout>
