---
/**
 * GitHub OAuth Callback Handler
 * Processes the OAuth response and creates a session
 */

import AuthLayout from '../../../layouts/AuthLayout.astro'
import { setAuthToken } from '../../../lib/session'

// Get code and state from query params
const code = Astro.url.searchParams.get('code')
const state = Astro.url.searchParams.get('state')
const error = Astro.url.searchParams.get('error')
const errorDescription = Astro.url.searchParams.get('error_description')

// Handle OAuth errors
if (error) {
  console.error('GitHub OAuth error:', error, errorDescription)
  return Astro.redirect(`/login?error=${encodeURIComponent(error)}`)
}

// Validate code
if (!code) {
  console.error('No OAuth code received')
  return Astro.redirect('/login?error=no_code')
}

// Exchange code for session token
try {
  const response = await fetch(`${import.meta.env.PUBLIC_API_URL || 'http://localhost:3000'}/api/trpc/auth.handleGitHubCallback`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      code,
      state,
    }),
  })

  if (!response.ok) {
    throw new Error(`Auth failed: ${response.status}`)
  }

  const data = await response.json()

  if (data.result?.data?.success) {
    const { session, returnTo } = data.result.data

    // Set auth token cookie
    setAuthToken(Astro.cookies, session.token)

    // Redirect to return URL or home
    return Astro.redirect(returnTo || '/')
  } else {
    throw new Error('Auth response invalid')
  }
} catch (error) {
  console.error('Failed to complete GitHub OAuth:', error)
  return Astro.redirect('/login?error=auth_failed')
}
---

<AuthLayout title="Authenticating">
  <!-- This page should always redirect, but just in case... -->
  <div class="min-h-screen flex items-center justify-center bg-gray-50">
    <div class="text-center">
      <div class="animate-spin inline-block w-8 h-8 border-4 border-gray-900 border-t-transparent rounded-full mb-4"></div>
      <p class="text-lg text-gray-900">Authenticating with GitHub...</p>
      <p class="text-sm text-gray-600 mt-2">If you are not redirected, <a href="/login" class="text-blue-600 hover:underline">click here</a>.</p>
    </div>
  </div>
</AuthLayout>
