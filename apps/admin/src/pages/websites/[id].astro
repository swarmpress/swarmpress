---
import Layout from '../../layouts/Layout.astro'
import WebsiteForm from '../../components/WebsiteForm'
import ContentGenerationPanel from '../../components/ContentGenerationPanel'
import WorkflowControlPanel from '../../components/workflows/WorkflowControlPanel'
import WeatherDashboard from '../../components/weather/WeatherDashboard'
import ContentCalendarView from '../../components/editorial/ContentCalendarView'
import { trpc, handleTRPCError } from '../../lib/trpc'

const { id } = Astro.params

if (!id) {
  return Astro.redirect('/websites')
}

let website: any = null
let error: string | null = null

try {
  website = await trpc.website.getById.query({ id })
} catch (e) {
  error = handleTRPCError(e)
  console.error('Failed to fetch website:', error)
}

if (!website) {
  return Astro.redirect('/websites')
}
---

<Layout title={`${website.title || website.domain} - Website`}>
  <div class="space-y-8">
    <div class="mb-8">
      <h1 class="text-3xl font-bold">{website.title || website.domain}</h1>
      <p class="text-muted-foreground mt-2">Manage website settings, content generation, and workflows</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Main Content Area - Panels -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Content Generation Panel -->
        <ContentGenerationPanel
          websiteId={website.id}
          websiteName={website.title || website.domain}
          client:load
        />

        <!-- Workflow Control Panel -->
        <WorkflowControlPanel
          websiteId={website.id}
          websiteName={website.title || website.domain}
          client:load
        />
      </div>

      <!-- Sidebar - Info, Weather, Quick Actions -->
      <div class="space-y-4">
        <!-- Weather Dashboard (Compact) -->
        <WeatherDashboard compact={true} client:load />

        <!-- Website Info -->
        <div class="p-4 rounded-lg border bg-card">
          <h3 class="font-semibold mb-3">Website Info</h3>
          <dl class="space-y-2 text-sm">
            <div>
              <dt class="text-muted-foreground">Domain</dt>
              <dd class="font-medium">{website.domain}</dd>
            </div>
            {website.description && (
              <div>
                <dt class="text-muted-foreground">Description</dt>
                <dd>{website.description}</dd>
              </div>
            )}
            <div>
              <dt class="text-muted-foreground">Created</dt>
              <dd>{new Date(website.created_at).toLocaleDateString()}</dd>
            </div>
          </dl>
        </div>

        <!-- Quick Links -->
        <div class="p-4 rounded-lg border bg-card">
          <h3 class="font-semibold mb-3">Quick Links</h3>
          <div class="space-y-2">
            <a
              href={`/sitemap?website=${id}`}
              class="flex items-center gap-2 text-sm text-primary hover:underline"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
              View Sitemap
            </a>
            <a
              href={`/editorial/kanban?website=${id}`}
              class="flex items-center gap-2 text-sm text-primary hover:underline"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
              Editorial Kanban
            </a>
            <a
              href={`/collections`}
              class="flex items-center gap-2 text-sm text-primary hover:underline"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5v14a9 3 0 0 0 18 0V5"/><path d="M3 12a9 3 0 0 0 18 0"/></svg>
              Collections
            </a>
            <a
              href={`/tools`}
              class="flex items-center gap-2 text-sm text-primary hover:underline"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
              Manage Tools
            </a>
            <a
              href={`/content?website=${id}`}
              class="flex items-center gap-2 text-sm text-primary hover:underline"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/></svg>
              View Content
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Content Calendar Section -->
    <div class="pt-8 border-t">
      <h2 class="text-xl font-semibold mb-4">Content Calendar</h2>
      <ContentCalendarView
        websiteId={website.id}
        websiteName={website.title || website.domain}
        client:load
      />
    </div>

    <!-- Full Weather Dashboard -->
    <div class="pt-8 border-t">
      <h2 class="text-xl font-semibold mb-4">Weather Overview</h2>
      <WeatherDashboard compact={false} client:load />
    </div>

    <!-- Website Settings Form -->
    <div class="pt-8 border-t">
      <h2 class="text-xl font-semibold mb-4">Website Settings</h2>
      <WebsiteForm website={website} mode="edit" client:load />
    </div>
  </div>
</Layout>
