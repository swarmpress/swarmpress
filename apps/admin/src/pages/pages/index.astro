---
/**
 * Pages List View
 * View and manage all pages for the current website
 */
import Layout from '../../layouts/Layout.astro'
import { trpc, handleTRPCError } from '../../lib/trpc'
import { getSessionContext } from '../../lib/session'

const title = 'Pages'

// Get session context (tenant + product)
const session = getSessionContext(Astro.cookies)
const websiteId = session.productId

let pages: any[] = []
let blueprints: any[] = []
let error: string | null = null

if (websiteId) {
  try {
    const [pagesResult, blueprintsResult] = await Promise.all([
      trpc.sitemap.listByWebsite.query({ websiteId }),
      trpc.blueprint.list.query({})
    ])
    pages = pagesResult.items || []
    blueprints = blueprintsResult.items || []
  } catch (e) {
    error = handleTRPCError(e)
    console.error('Failed to fetch pages:', error)
  }
}

// Group pages by page_type
const pagesByType = pages.reduce((acc: Record<string, any[]>, page: any) => {
  const type = page.page_type || 'uncategorized'
  if (!acc[type]) acc[type] = []
  acc[type].push(page)
  return acc
}, {})

const statusColors: Record<string, string> = {
  published: 'bg-green-100 text-green-800',
  draft: 'bg-yellow-100 text-yellow-800',
  planned: 'bg-blue-100 text-blue-800',
  outdated: 'bg-orange-100 text-orange-800',
  deprecated: 'bg-red-100 text-red-800',
}
---

<Layout title={title}>
  <div class="mb-8">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Pages</h1>
        <p class="text-gray-600 mt-2">
          Manage sitemap pages, assign blueprints, and trigger content generation
        </p>
      </div>
      <a
        href="/pages/new"
        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors flex items-center gap-2"
      >
        <span>+</span>
        <span>New Page</span>
      </a>
    </div>
  </div>

  {!websiteId ? (
    <div class="text-center py-12 bg-white rounded-lg border">
      <div class="text-6xl mb-4">ğŸŒ</div>
      <h3 class="text-xl font-semibold text-gray-900 mb-2">No Website Selected</h3>
      <p class="text-gray-600 mb-6">
        Please select a website from the sidebar to view its pages
      </p>
      <a
        href="/websites"
        class="inline-block px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
      >
        Go to Websites
      </a>
    </div>
  ) : error ? (
    <div class="text-center py-12 text-red-600 bg-white rounded-lg border">
      <p>Failed to load pages: {error}</p>
    </div>
  ) : pages.length === 0 ? (
    <div class="text-center py-12 bg-white rounded-lg border">
      <div class="text-6xl mb-4">ğŸ“„</div>
      <h3 class="text-xl font-semibold text-gray-900 mb-2">No Pages Yet</h3>
      <p class="text-gray-600 mb-6">
        Create your first page or import from sitemap
      </p>
      <div class="flex items-center justify-center gap-4">
        <a
          href="/pages/new"
          class="inline-block px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
        >
          Create First Page
        </a>
        <a
          href="/sitemap"
          class="inline-block px-6 py-3 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors"
        >
          View Sitemap
        </a>
      </div>
    </div>
  ) : (
    <div class="space-y-8">
      {/* Stats Bar */}
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-white rounded-lg border p-4">
          <div class="text-2xl font-bold text-gray-900">{pages.length}</div>
          <div class="text-sm text-gray-500">Total Pages</div>
        </div>
        <div class="bg-white rounded-lg border p-4">
          <div class="text-2xl font-bold text-green-600">
            {pages.filter((p: any) => p.status === 'published').length}
          </div>
          <div class="text-sm text-gray-500">Published</div>
        </div>
        <div class="bg-white rounded-lg border p-4">
          <div class="text-2xl font-bold text-yellow-600">
            {pages.filter((p: any) => p.status === 'draft').length}
          </div>
          <div class="text-sm text-gray-500">Drafts</div>
        </div>
        <div class="bg-white rounded-lg border p-4">
          <div class="text-2xl font-bold text-blue-600">
            {Object.keys(pagesByType).length}
          </div>
          <div class="text-sm text-gray-500">Page Types</div>
        </div>
      </div>

      {/* Pages by Type */}
      {Object.entries(pagesByType).map(([type, typePages]: [string, any[]]) => (
        <div class="bg-white rounded-lg border">
          <div class="px-6 py-4 border-b bg-gray-50 flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="text-lg">ğŸ“</span>
              <h2 class="text-lg font-semibold text-gray-900 capitalize">
                {type.replace(/_/g, ' ')}
              </h2>
              <span class="px-2 py-0.5 bg-gray-200 text-gray-600 text-xs rounded-full">
                {typePages.length}
              </span>
            </div>
          </div>
          <div class="divide-y">
            {typePages.map((page: any) => (
              <a
                href={`/pages/${page.id}`}
                class="block px-6 py-4 hover:bg-gray-50 transition-colors"
              >
                <div class="flex items-center justify-between">
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-3">
                      <h3 class="text-sm font-medium text-gray-900 truncate">
                        {page.title}
                      </h3>
                      <span class={`px-2 py-0.5 text-xs rounded-full ${statusColors[page.status] || 'bg-gray-100 text-gray-600'}`}>
                        {page.status}
                      </span>
                      {page.blueprint_id && (
                        <span class="px-2 py-0.5 bg-purple-100 text-purple-700 text-xs rounded-full flex items-center gap-1">
                          <span>ğŸ“</span>
                          <span>Blueprint</span>
                        </span>
                      )}
                    </div>
                    <div class="mt-1 flex items-center gap-4 text-sm text-gray-500">
                      <span class="flex items-center gap-1">
                        <span>ğŸ”—</span>
                        <span class="truncate max-w-xs">/{page.slug}</span>
                      </span>
                      <span class="flex items-center gap-1">
                        <span>ğŸ“…</span>
                        <span>{new Date(page.updated_at).toLocaleDateString()}</span>
                      </span>
                    </div>
                  </div>
                  <div class="ml-4 flex items-center gap-2">
                    <span class="text-gray-400">â†’</span>
                  </div>
                </div>
              </a>
            ))}
          </div>
        </div>
      ))}
    </div>
  )}
</Layout>
