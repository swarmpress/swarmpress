# Publishing & Deployment

> **Last Updated:** 2026-01-25
> **Status:** Current

This document describes the complete publishing process from approved content to a live website deployed on GitHub Pages.

---

## Overview

The publishing process is a multi-step workflow orchestrated by Temporal that:

1. Validates content quality (QA Gate)
2. Optimizes for SEO
3. Builds a static Astro site
4. Deploys to GitHub Pages
5. Merges the content PR
6. Emits success events

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Publishing Pipeline                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Content      QA        SEO       Build      Deploy    Publish â”‚
â”‚  Approved  â†’  Gate  â†’  Optimize â†’ Site   â†’   Pages  â†’  Live   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Publishing Workflow

The publishing workflow is managed by Temporal and consists of 9 steps.

### Workflow Steps

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Fetch    â”‚  Get content from database
â”‚    Content  â”‚  Validate content exists
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. QA Gate  â”‚  Media relevance check
â”‚ (optional)  â”‚  Link validation
â”‚             â”‚  Editorial coherence
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. SEO      â”‚  Optimize title, meta
â”‚ Optimize    â”‚  Keywords, alt text
â”‚             â”‚  Log to GitHub PR
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. State    â”‚  Transition content
â”‚ Transition  â”‚  to "scheduled" status
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Validate â”‚  Check JSON block structure
â”‚ Engineering â”‚  Validate images have URLs
â”‚             â”‚  Log to GitHub PR
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Build    â”‚  Generate Astro pages
â”‚ Static Site â”‚  Process collections
â”‚             â”‚  Run Astro build
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. Deploy   â”‚  Upload files to GitHub
â”‚ to Pages    â”‚  Update gh-pages branch
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. Merge PR â”‚  Merge content GitHub PR
â”‚             â”‚  Mark as deployed
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. Finalize â”‚  Transition to "published"
â”‚             â”‚  Emit success events
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Workflow Input

```typescript
interface PublishingWorkflowInput {
  contentId: string           // Content item to publish
  websiteId: string           // Target website
  seoAgentId: string          // SEO optimization agent
  engineeringAgentId: string  // Build/deploy agent
  buildFromGitHub?: boolean   // Use GitHub as source (default: false)
  qaGateConfig?: {            // QA validation options
    enabled: boolean
    mediaCheck: boolean
    linkValidation: boolean
    coherenceCheck: boolean
  }
}
```

### Workflow Output

```typescript
interface PublishingWorkflowResult {
  success: boolean
  publishedUrl: string        // Live URL
  deploymentTime: number      // Duration in ms
  qaGateResult?: {
    passed: boolean
    issues: string[]
  }
}
```

---

## Build Process

Two build modes are supported depending on where content is stored.

### Build from Database (Default)

When `buildFromGitHub = false`, content is fetched from PostgreSQL:

```
PostgreSQL
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Fetch website configuration          â”‚
â”‚ 2. Fetch all published content items    â”‚
â”‚ 3. Generate Astro page files:           â”‚
â”‚    - src/pages/index.astro              â”‚
â”‚    - src/pages/{slug}.astro             â”‚
â”‚ 4. Generate collection pages            â”‚
â”‚ 5. Copy layouts and components          â”‚
â”‚ 6. Run: pnpm install && pnpm build      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
dist/ directory
```

### Build from GitHub

When `buildFromGitHub = true`, content is fetched from the GitHub repository:

```
GitHub Repository
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Clone content from repository        â”‚
â”‚ 2. Load sitemap: content/sitemap.json   â”‚
â”‚ 3. Load pages: content/pages/*.json     â”‚
â”‚ 4. Load collections: content/collectionsâ”‚
â”‚ 5. Expand i18n (EN, DE, FR, IT)         â”‚
â”‚ 6. Generate Astro pages dynamically     â”‚
â”‚ 7. Support multi-language routing       â”‚
â”‚ 8. Run Astro build                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
dist/ directory
```

### Content Structure (GitHub)

```
repository/
â”œâ”€â”€ content/
â”‚   â”œâ”€â”€ sitemap.json           # Site structure
â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â”œâ”€â”€ index.json         # Homepage
â”‚   â”‚   â”œâ”€â”€ about.json         # About page
â”‚   â”‚   â””â”€â”€ village/
â”‚   â”‚       â””â”€â”€ riomaggiore.json
â”‚   â””â”€â”€ collections/
â”‚       â”œâ”€â”€ restaurants/
â”‚       â”‚   â””â”€â”€ riomaggiore.json
â”‚       â””â”€â”€ accommodations/
â”‚           â””â”€â”€ riomaggiore.json
â””â”€â”€ config/
    â”œâ”€â”€ navigation.json
    â””â”€â”€ villages/
        â””â”€â”€ riomaggiore.json
```

---

## GitHub Pages Deployment

### Deployment API

The backend provides a tRPC endpoint for deploying to GitHub Pages:

```typescript
// Endpoint: github.deployToPages
await trpc.github.deployToPages.mutate({
  websiteId: 'uuid',
  files: [
    { path: 'index.html', content: '<html>...</html>' },
    { path: 'about/index.html', content: '...' },
    { path: 'assets/style.css', content: '...' }
  ],
  commitMessage: 'Deploy: Update content'
})
```

### Deployment Process

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  GitHub Pages Deployment                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  1. Collect files from dist/ directory                       â”‚
â”‚     â””â”€ index.html, assets/, images/, etc.                   â”‚
â”‚                                                              â”‚
â”‚  2. Create GitHub blobs for each file                        â”‚
â”‚     â””â”€ POST /repos/{owner}/{repo}/git/blobs                 â”‚
â”‚     â””â”€ Returns SHA for each blob                            â”‚
â”‚                                                              â”‚
â”‚  3. Create tree from blobs                                   â”‚
â”‚     â””â”€ POST /repos/{owner}/{repo}/git/trees                 â”‚
â”‚     â””â”€ Links all blobs into directory structure             â”‚
â”‚                                                              â”‚
â”‚  4. Create commit on tree                                    â”‚
â”‚     â””â”€ POST /repos/{owner}/{repo}/git/commits               â”‚
â”‚     â””â”€ References the tree and parent commit                â”‚
â”‚                                                              â”‚
â”‚  5. Update branch reference                                  â”‚
â”‚     â””â”€ PATCH /repos/{owner}/{repo}/git/refs/heads/gh-pages  â”‚
â”‚     â””â”€ Points branch to new commit                          â”‚
â”‚                                                              â”‚
â”‚  6. Add CNAME file (if custom domain)                        â”‚
â”‚     â””â”€ Contains custom domain for GitHub Pages              â”‚
â”‚                                                              â”‚
â”‚  7. Update website deployment status                         â”‚
â”‚     â””â”€ deployment_status = 'deployed'                       â”‚
â”‚     â””â”€ last_deployed_at = NOW()                             â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Deployment Targets

| Target | Description | Configuration |
|--------|-------------|---------------|
| **github-pages** | GitHub Pages hosting | OAuth token + repo connection |
| **netlify** | Netlify static hosting | Site ID + auth token |
| **s3** | AWS S3 bucket | AWS credentials + bucket name |
| **local** | Local directory | Path to output directory |

---

## Database Schema

### Website Deployment Fields

```sql
-- GitHub Pages configuration
github_pages_enabled BOOLEAN DEFAULT FALSE,
github_pages_url TEXT,           -- e.g., 'https://user.github.io/repo'
github_pages_branch TEXT DEFAULT 'gh-pages',
github_pages_path TEXT DEFAULT '/',
github_pages_custom_domain TEXT, -- e.g., 'cinqueterre.travel'

-- Deployment tracking
last_deployed_at TIMESTAMPTZ,
deployment_status TEXT DEFAULT 'never_deployed',
deployment_error TEXT
```

### Deployment Statuses

| Status | Description |
|--------|-------------|
| `never_deployed` | No deployment has occurred |
| `deploying` | Deployment in progress |
| `deployed` | Successfully deployed |
| `failed` | Deployment failed (see error) |

---

## Engineering Agent

The **EngineeringAgent** handles build and deployment tasks.

### Available Tools

| Tool | Description |
|------|-------------|
| `get_website_info` | Get website config and stats |
| `validate_content` | Check JSON blocks are valid |
| `build_site` | Generate static site from database |
| `build_from_github` | Generate static site from GitHub |
| `deploy_site` | Deploy to hosting platform |
| `publish_website` | Complete workflow (validate â†’ build â†’ deploy) |

### Tool Example

```typescript
// EngineeringAgent builds and deploys
await engineeringAgent.callTool('publish_website', {
  website_id: 'uuid',
  deploy_target: 'github-pages',
  skip_validation: false
})
```

---

## QA Gate

The optional QA Gate validates content before publishing.

### Checks Performed

| Check | Description | Agent |
|-------|-------------|-------|
| **Media Relevance** | Images match content context | MediaSelectorAgent |
| **Link Validation** | No broken internal/external links | LinkerAgent |
| **Editorial Coherence** | Content flows logically | PagePolishAgent |
| **Completeness** | All required sections present | AuditAgent |

### Auto-Fix Capability

When issues are found, agents attempt automatic fixes:

```
Issue Found: Broken image link
    â†“
MediaSelectorAgent triggered
    â†“
Searches for replacement image
    â†“
Updates content with new image
    â†“
Re-validate
```

### QA Gate Result

```typescript
interface QAGateResult {
  passed: boolean
  issues: Array<{
    type: 'media' | 'link' | 'coherence' | 'completeness'
    severity: 'error' | 'warning'
    message: string
    autoFixed: boolean
  }>
}
```

---

## GitHub PR Integration

Throughout the publishing process, activity is logged to the content's GitHub PR.

### PR Comments

Each agent step adds a comment to the PR:

```markdown
## ğŸ” SEO Optimization Complete

**Agent:** SEOSpecialist
**Time:** 2026-01-25 14:32:00

### Changes Made
- âœ… Updated meta title
- âœ… Added 3 secondary keywords
- âœ… Improved meta description

### Recommendations
- Consider adding alt text to hero image
```

### Status Indicators

| Emoji | Status |
|-------|--------|
| âœ… | Success |
| âŒ | Failure |
| â³ | Pending |
| âš ï¸ | Warning |

---

## Complete Flow Example

### Publishing a Blog Post

```
1. WriterAgent creates content
   â””â”€ Content stored in database (status: draft)
   â””â”€ GitHub PR created for review

2. EditorAgent reviews and approves
   â””â”€ Content status â†’ approved
   â””â”€ PR ready to merge

3. Publishing workflow triggered
   â””â”€ Input: contentId, websiteId, buildFromGitHub=true

4. Workflow executes:

   a) Fetch content âœ“

   b) QA Gate
      â”œâ”€ Check media â†’ PASS
      â”œâ”€ Check links â†’ PASS
      â””â”€ Check coherence â†’ PASS

   c) SEO Optimize
      â”œâ”€ Title optimized
      â”œâ”€ Meta description updated
      â””â”€ Logged to PR

   d) Validate structure âœ“

   e) Build from GitHub
      â”œâ”€ Clone repository
      â”œâ”€ Load content/pages/blog/my-post.json
      â”œâ”€ Expand i18n (EN, DE, FR, IT)
      â”œâ”€ Generate Astro pages
      â””â”€ Run Astro build â†’ dist/

   f) Deploy to GitHub Pages
      â”œâ”€ Create blobs for 150 files
      â”œâ”€ Create tree
      â”œâ”€ Create commit
      â””â”€ Update gh-pages branch

   g) Merge PR âœ“

   h) Status â†’ published âœ“

   i) Emit events âœ“

5. Site live at https://cinqueterre.travel/blog/my-post/
```

---

## API Reference

### GitHub Router

| Endpoint | Method | Description |
|----------|--------|-------------|
| `github.enablePages` | Mutation | Enable GitHub Pages for website |
| `github.deployToPages` | Mutation | Deploy files to Pages |
| `github.getDeploymentStatus` | Query | Get current deployment status |
| `github.setCustomDomain` | Mutation | Configure custom domain |

### Workflow API

| Endpoint | Method | Description |
|----------|--------|-------------|
| `workflow.startPublishing` | Mutation | Start publishing workflow |
| `workflow.getResult` | Query | Get workflow result |

---

## Deployment Scripts

### Manual Deployment

For manual deployments outside the workflow:

```bash
# Deploy Cinque Terre site
npx tsx scripts/deploy-cinqueterre.ts

# Steps performed:
# 1. Check prerequisites (directories, git status)
# 2. Run Astro build
# 3. Deploy dist/ to gh-pages branch
# 4. Verify deployment
```

### Theme Deployment Script

```bash
# From theme directory
./scripts/deploy-gh-pages.sh

# Steps:
# 1. Build Astro site
# 2. Create CNAME for custom domain
# 3. Add .nojekyll file
# 4. Push to gh-pages branch
```

---

## Troubleshooting

### Deployment Failed

1. Check deployment status in database:
```sql
SELECT deployment_status, deployment_error
FROM websites WHERE id = 'uuid';
```

2. Verify GitHub token has required permissions:
   - `repo` scope for full repository access
   - Write access to repository

3. Check gh-pages branch exists

### Build Failed

1. Validate content JSON structure:
```bash
npx tsx scripts/validate-content.ts --websiteId=uuid
```

2. Check for missing images or invalid URLs

3. Review Astro build logs in Temporal UI

### QA Gate Blocking

1. Review QA Gate result for specific issues
2. Fix identified problems
3. Re-trigger publishing workflow

---

## Related Documentation

- [Workflows](./workflows) - Temporal workflow details
- [Agents](./agents) - Agent capabilities
- [GitHub Integration](./github-integration) - GitHub setup
- [API Reference](../reference/api) - Full API docs
